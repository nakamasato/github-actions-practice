# .github/workflows/matrix-failure-detection.yml
name: matrix-failure-detection

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Matrixæˆ¦ç•¥ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–
  matrix-job:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # ä¸€ã¤ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã‚’ç¶šè¡Œ
      matrix:
        node-version: [14, 16, 18, 20]
    name: matrix-job-${{ matrix.node-version }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Get current job ID
        id: get-job-id
        uses: ayachensiyuan/get-action-job-id@v1.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          job-name: matrix-job-${{ matrix.node-version }}
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      # å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆ/ãƒ“ãƒ«ãƒ‰å‡¦ç†ï¼ˆãƒ‡ãƒ¢ç”¨ã«æ„å›³çš„ã«ä¸€éƒ¨ã‚’å¤±æ•—ã•ã›ã‚‹ï¼‰
      - name: Run tests
        id: tests
        run: |
          echo "Testing with Node.js ${{ matrix.node-version }}"
          # ãƒ‡ãƒ¢ç”¨ï¼šNode.js 14ã§ã¯å¤±æ•—ã•ã›ã‚‹
          if [ "${{ matrix.node-version }}" = "14" ]; then
            echo "Simulating test failure for Node.js 14"
            exit 1
          fi
          echo "Tests passed!"
        continue-on-error: true
      
      # çµæœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
      - name: Save job result
        if: always()
        run: |
          mkdir -p results
          echo "{
            \"job_id\": \"${{ steps.get-job-id.outputs.jobId }}\",
            \"node_version\": \"${{ matrix.node-version }}\",
            \"test_status\": \"${{ steps.tests.outcome }}\",
            \"github_job_status\": \"${{ job.status }}\",
            \"run_id\": \"${{ github.run_id }}\",
            \"run_number\": \"${{ github.run_number }}\"
          }" > results/result.json
          
          echo "GitHub Job ID: ${{ steps.get-job-id.outputs.jobId }}"
          echo "Test outcome: ${{ steps.tests.outcome }}"
      
      - name: Upload job result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: job-result-${{ steps.get-job-id.outputs.jobId }}
          path: results/

  # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã‚’æ¤œå‡ºãƒ»é›†ç´„ã™ã‚‹ã‚¸ãƒ§ãƒ–
  collect-failures:
    needs: matrix-job
    runs-on: ubuntu-latest
    if: always()  # matrix-jobãŒå¤±æ•—ã—ã¦ã‚‚å®Ÿè¡Œ
    
    outputs:
      failed_count: ${{ steps.analyze.outputs.failed_count }}
      has_failures: ${{ steps.analyze.outputs.has_failures }}
      failed_jobs_matrix: ${{ steps.analyze.outputs.failed_jobs_matrix }}
    
    steps:
      - name: Download all job results
        uses: actions/download-artifact@v4
        with:
          path: all-results/
          pattern: job-result-*
      
      - name: Install jq
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
      
      - name: Analyze failed jobs
        id: analyze
        run: |
          failed_jobs=()
          failed_details=""
          total_jobs=0
          
          echo "=== Job Results Analysis ==="
          
          # çµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ç´¢
          for result_dir in all-results/job-result-*/; do
            if [ -d "$result_dir" ]; then
              result_file="$result_dir/result.json"
              if [ -f "$result_file" ]; then
                total_jobs=$((total_jobs + 1))
                
                job_id=$(jq -r '.job_id' "$result_file")
                test_status=$(jq -r '.test_status' "$result_file")
                github_job_status=$(jq -r '.github_job_status' "$result_file")
                node_version=$(jq -r '.node_version' "$result_file")
                
                echo "Job ID: $job_id | Test Status: $test_status | Job Status: $github_job_status | Node: $node_version"
                
                # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã€ã¾ãŸã¯ã‚¸ãƒ§ãƒ–è‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆ
                if [[ "$test_status" == "failure" ]] || [[ "$github_job_status" == "failure" ]]; then
                  failed_jobs+=("$job_id")
                  failed_details+="- **Job ID $job_id**: Node.js $node_version (Test: $test_status, Job: $github_job_status)\n"
                fi
              fi
            fi
          done
          
          echo ""
          echo "=== Failed Jobs Summary ==="
          echo "Total jobs: $total_jobs"
          
          if [ ${#failed_jobs[@]} -eq 0 ]; then
            echo "âœ… All matrix jobs succeeded!"
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "failed_jobs_matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed jobs count: ${#failed_jobs[@]}"
            echo "Failed job IDs:"
            printf '%s\n' "${failed_jobs[@]}"
            
            # matrixã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®JSONé…åˆ—ã‚’ç”Ÿæˆ
            failed_jobs_json="["
            for i in "${!failed_jobs[@]}"; do
              if [ $i -gt 0 ]; then
                failed_jobs_json+=","
              fi
              failed_jobs_json+="\"${failed_jobs[$i]}\""
            done
            failed_jobs_json+="]"
            
            echo "Failed jobs JSON for matrix: $failed_jobs_json"
            
            # GitHub Outputã«è¨­å®š
            echo "failed_count=${#failed_jobs[@]}" >> $GITHUB_OUTPUT
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "failed_jobs_matrix=$failed_jobs_json" >> $GITHUB_OUTPUT
          fi
      
      - name: Create failure summary
        if: steps.analyze.outputs.has_failures == 'true'
        run: |
          {
            echo "## ğŸš¨ Matrix Job Failures Detected"
            echo ""
            echo "**Failed Jobs Count:** ${{ steps.analyze.outputs.failed_count }}"
            echo ""
            echo "**Failed Job IDs for matrix:**"
            echo '```json'
            echo "${{ steps.analyze.outputs.failed_jobs_matrix }}"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Post comment on PR (if applicable)
        if: github.event_name == 'pull_request' && steps.analyze.outputs.has_failures == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const failedJobsMatrix = JSON.parse(`${{ steps.analyze.outputs.failed_jobs_matrix }}`);
            
            const comment = `## ğŸš¨ Matrix Job Failures
            
            **${failedJobsMatrix.length} job(s) failed in the matrix build:**
            
            Failed Job IDs: ${failedJobsMatrix.join(', ')}
            
            **Matrix JSON for reprocessing:**
            \`\`\`json
            ${{ steps.analyze.outputs.failed_jobs_matrix }}
            \`\`\`
            
            Please check the workflow logs for more details.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–IDã«å¯¾ã—ã¦matrixæˆ¦ç•¥ã§å‡¦ç†ã™ã‚‹ã‚¸ãƒ§ãƒ–
  handle-failures:
    needs: collect-failures
    runs-on: ubuntu-latest
    if: needs.collect-failures.outputs.has_failures == 'true'
    strategy:
      matrix:
        job_id: ${{ fromJson(needs.collect-failures.outputs.failed_jobs_matrix) }}
    
    steps:
      - name: Process failed job
        run: |
          echo "Processing failed job ID: ${{ matrix.job_id }}"
          
          # ã“ã“ã§å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–IDã«å¯¾ã™ã‚‹å‡¦ç†ã‚’å®Ÿè¡Œ
          # ä¾‹ï¼šå†å®Ÿè¡Œã€é€šçŸ¥ã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãªã©
          echo "Handling failure for job: ${{ matrix.job_id }}"
      
      - name: Send specific notification
        run: |
          echo "ğŸš¨ Sending notification for failed job: ${{ matrix.job_id }}"
          # ã“ã“ã§å€‹åˆ¥ã®é€šçŸ¥å‡¦ç†ã‚’å®Ÿè£…
          # ä¾‹ï¼šSlackã€Teamsã€ãƒ¡ãƒ¼ãƒ«ãªã©

  # æˆåŠŸæ™‚ã®å‡¦ç†ä¾‹
  handle-success:
    needs: collect-failures
    runs-on: ubuntu-latest
    if: needs.collect-failures.outputs.has_failures == 'false'
    
    steps:
      - name: All jobs succeeded
        run: |
          echo "âœ… All matrix jobs completed successfully!"
          echo "No failed jobs to process."
